<script defer>
(function(){
  const NIVEL = window.NIVEL || 'fundacao-72a9c';
  const GOALS_KEY = `bp_goals_${NIVEL}`;
  const $ = s => document.querySelector(s);
  const LS = {
    get:(k,def)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch(_){ return def } },
    set:(k,v)=> localStorage.setItem(k, JSON.stringify(v))
  };

  function escapeHtml(s){return (s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}
  function getGoals(){ return LS.get(GOALS_KEY, []); }
  function setGoals(arr){ LS.set(GOALS_KEY, arr); }

  function renderGoals(){
    const list = $('#goalsList');
    if(!list) return;
    const goals = getGoals();
    if(!goals.length){
      list.innerHTML = '<div class="muted">Nenhuma meta cadastrada ainda.</div>';
      return;
    }
    list.innerHTML = goals.map(g => `
      <div class="goal-card" data-id="${g.id}">
        <div class="hdr">
          <div class="name">${escapeHtml(g.name)}</div>
          <div class="small muted">${g.createdISO || ''}</div>
        </div>
        <small class="muted">0/${g.days} dias completos</small>
        <div class="row-actions" style="margin-top:8px">
          <button class="btn ghost" data-del="${g.id}">Excluir</button>
        </div>
      </div>
    `).join('');
  }

  function saveGoal(){
    const name = ($('#goal_name')?.value || '').trim();
    const days = parseInt($('#goal_days')?.value, 10) || 20;
    if(!name) return;

    const goals = getGoals();
    goals.unshift({
      id: Date.now().toString(36),
      name,
      days,
      createdISO: new Date().toISOString().slice(0,10)
    });
    setGoals(goals);

    // atualiza “alvo” atual (já existente no card)
    if($('#goalCurrentWrap')){
      $('#goalCurrentWrap').style.display = 'block';
      $('#goalCurrentName').textContent = name;
      $('#goalProgress').style.width = '0%';
      $('#goalProgressText').textContent = `Progresso: 0/${days} dias completos`;
      const note = $('#goalResetNote'); if(note) note.style.display = 'none';
    }

    // limpa inputs e re-renderiza lista
    if($('#goal_name')) $('#goal_name').value = '';
    if($('#goal_days')) $('#goal_days').value = '';
    renderGoals();
  }

  function clearGoalInputs(){
    if($('#goal_name')) $('#goal_name').value = '';
    if($('#goal_days')) $('#goal_days').value = '';
  }

  function handleDelete(e){
    const id = e.target?.dataset?.del;
    if(!id) return;
    const goals = getGoals().filter(g => g.id !== id);
    setGoals(goals);
    renderGoals();
  }

  document.addEventListener('DOMContentLoaded', () => {
    // botões já presentes no HTML
    $('#btnSaveGoal')?.addEventListener('click', saveGoal);
    $('#btnClearGoal')?.addEventListener('click', clearGoalInputs);
    $('#goalsList')?.addEventListener('click', handleDelete);

    renderGoals();
  });
})();
</script>