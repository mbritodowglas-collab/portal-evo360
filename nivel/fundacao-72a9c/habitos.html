<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EVO360 · Fundação · Hábitos e Recompensas</title>
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" href="../../assets/css/base.css?v=18">
  <link rel="stylesheet" href="../../assets/css/tema-fundacao.css?v=18">
  <meta name="theme-color" content="#0b0d10">
  <style>
    /* ===== Ajustes locais desta página ===== */
    .content p, .content li { text-align: justify; }

    /* Tabs */
    .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#0f1318;cursor:pointer}
    .tab.active{border-color:rgba(203,229,255,.35);background:#12161B}

    .panel{display:none}
    .panel.active{display:block}

    /* Listas de hábitos */
    .habits-group{margin-top:12px}
    .habits-title{font-weight:800;color:var(--serenity-2);margin:8px 0}
    .habits-grid{display:grid;grid-template-columns:1fr;gap:10px;align-items:center}
    @media (min-width:760px){ .habits-grid{grid-template-columns:1fr 1fr} }
    .habit-item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);background:#0f1318;padding:10px;border-radius:12px;min-height:48px}
    .habit-item input[type="checkbox"]{width:20px;height:20px;accent-color:#6fb7ff;cursor:pointer}

    .row-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Meta atual */
    .progress-wrap{margin-top:10px}
    .progress{height:8px;border-radius:999px;background:#0d1116;border:1px solid var(--line);overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,#67b2ff,#89d1ff)}
    .muted-ok{display:flex;gap:8px;align-items:center;margin-top:10px}

    /* Lista de metas salvas */
    .goal-list{display:grid;gap:10px;margin-top:10px}
    .goal-card{border:1px solid var(--line);background:#0f1318;border-radius:12px;padding:10px}
    .goal-card .hdr{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .goal-card .name{font-weight:700}
    .goal-card small{color:var(--silver)}

    /* === Progresso (20 dias por hábito) – título em cima, bolinhas abaixo === */
    .streak-box{ margin-top:18px }
    .streak-legend{ color:var(--silver); margin-top:6px }
    .streak-list{ display:grid; gap:12px; margin-top:12px }
    .streak-row{ display:flex; flex-direction:column; gap:6px }
    .streak-label{ color:var(--silver); font-weight:600 }
    .streak-grid{ display:grid; grid-template-columns:repeat(20,12px); gap:6px; }
    .dot{ width:12px; height:12px; border-radius:50%; background:#40464f; border:1px solid #30343b }
    .dot.ok{ background:#31b57a; border-color:#2a9465 }   /* marcado */
    .dot.no{ background:#d04c4c; border-color:#a53b3b }   /* não marcado */
  </style>
</head>

<body class="layout-with-sidebar">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Navegação do Nível Fundação">
    <div class="sb-header">
      <img src="../../assets/img/logo.svg" class="logo" alt="EVO360">
      <div class="nivel">Nível Fundação</div>
    </div>
    <nav class="sb-nav">
      <a class="sb-item" href="./">Início</a>
      <a class="sb-item" href="./dicas-orientacoes.html">Dicas e Orientações</a>
      <a class="sb-item" href="./plano.html">Tarefas e Neuro-Hábito</a>
      <a class="sb-item active" href="./habitos.html">Hábitos e Recompensas</a>
      <a class="sb-item" href="./praticas.html">Práticas Mentais</a>
      <a class="sb-item" href="./suporte.html">Suporte</a>
    </nav>
    <div class="sb-footer"><div class="quote">Você está florescendo.</div><div class="ver">v1.0 · © Bella Prime</div></div>
  </aside>

  <!-- Conteúdo -->
  <main class="content">
    <!-- Banner -->
    <header class="banner-full" style="background-image:url('../../assets/img/hub/banner-fundacao-hero.jpg')" aria-hidden="true"></header>

    <!-- Card -->
    <section class="card">
      <h2>Hábitos e Recompensas</h2>
      <p>
        Marque seus hábitos <strong>diariamente</strong>, defina uma <strong>recompensa significativa</strong> e acompanhe sua evolução.
        O objetivo é cultivar constância, celebrar conquistas e manter um ritmo sustentável ao longo do Nível Fundação (60 dias).
      </p>

      <div class="tabs">
        <button class="tab active" data-tab="rastreador">Rastreador diário</button>
        <button class="tab" data-tab="recompensas">Recompensas</button>
        <button class="tab" data-tab="ferramentas">Ferramentas</button>
      </div>

      <!-- Painel: Rastreador -->
      <div class="panel active" id="panel-rastreador">
        <p class="muted">Marque os hábitos do dia. Ao salvar, as marcações de hoje ficam bloqueadas até amanhã.</p>

        <div class="habits-group">
          <div class="habits-title">Essenciais (contam para “dia completo”)</div>
          <div class="habits-grid" id="essenciais">
            <label class="habit-item"><input type="checkbox" data-habit="agua"><span>Água na meta do dia</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="sono"><span>Higiene do sono (rotina + ≥7h)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="movimento"><span>Movimento do dia (≥30 min leve/mod.)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="alimentacao"><span>Alimentação consciente (3 boas escolhas)</span></label>
          </div>
        </div>

        <div class="habits-group">
          <div class="habits-title">Complementares (registro extra)</div>
          <div class="habits-grid" id="complementares">
            <label class="habit-item"><input type="checkbox" data-habit="mobilidade"><span>Mobilidade/Postura (5–10 min)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="sol"><span>Ar livre / Sol (10–15 min)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="forca"><span>Treino de força/musculação</span></label>
          </div>
        </div>

        <div class="row-actions">
          <button class="btn" id="btnSaveDay">Salvar dia</button>
          <button class="btn ghost" id="btnClearDay">Limpar marcações</button>
        </div>

        <div class="alert info muted-ok" id="saveInfo" style="display:none">
          <span>✅ Dia salvo. As marcações de hoje estão bloqueadas. Volte amanhã.</span>
        </div>

        <!-- Progresso 20 dias por hábito -->
        <div class="streak-box" id="progress20">
          <h3 class="habits-title">Progresso (últimos 20 dias)</h3>
          <div class="streak-legend">Verde = marcado; Vermelho = não marcado; Cinza = sem registro.</div>
          <div id="streakList" class="streak-list" aria-live="polite"></div>
        </div>
      </div>

      <!-- Painel: Recompensas -->
      <div class="panel" id="panel-recompensas">
        <h3 class="habits-title">Meta de recompensa (baseada em dias completos)</h3>

        <div class="grid-2">
          <label>Recompensa (ex.: “Spa em casa”, “Filme + pipoca”)<br>
            <input type="text" id="goal_name" placeholder="Ex.: Spa em casa">
          </label>
          <label>Dias completos para merecer<br>
            <input type="number" id="goal_days" min="1" max="60" placeholder="Ex.: 20">
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="btnSaveGoal">Salvar meta</button>
          <button class="btn ghost" id="btnClearGoal">Limpar meta</button>
        </div>

        <div class="progress-wrap" id="goalCurrentWrap" style="display:none">
          <div class="muted">Alvo: <strong id="goalCurrentName"></strong></div>
          <div class="progress"><i id="goalProgress" style="width:0%"></i></div>
          <div class="muted" id="goalProgressText">Progresso: —</div>
          <div class="muted" id="goalResetNote" style="display:none">Contagem reiniciada por 3 ausências seguidas.</div>
        </div>

        <hr class="divisor">

        <h3 class="habits-title">Minhas metas</h3>
        <div id="goalsList" class="goal-list">
          <div class="muted">Nenhuma meta cadastrada ainda.</div>
        </div>

        <!-- Aviso de regra -->
        <p class="muted" style="margin-top:12px">
          <strong>Regra:</strong> caso ocorram <strong>3 ausências seguidas</strong> (dias não completos),
          a contagem da recompensa é <strong>zerada</strong> automaticamente.
        </p>
      </div>

      <!-- Painel: Ferramentas (simples) -->
      <div class="panel" id="panel-ferramentas">
        <p class="muted">Pequenas ferramentas que ajudam a manter bons hábitos.</p>
        <div class="grid-2">
          <label>Calculadora simples de água (ml/kg) — alvo sugerido 30–35 ml/kg<br>
            <input type="number" id="w_peso" placeholder="Peso (kg)">
          </label>
          <div class="calc-out" id="w_out">Informe seu peso para estimar a meta diária de água.</div>
        </div>
      </div>
    </section>
  </main>

  <script>window.NIVEL="fundacao-72a9c";</script>

  <!-- Script adicional: Progresso 20 dias por hábito + reset 3 ausências -->
  <script defer>
  (function(){
    const NIVEL = window.NIVEL || 'fundacao-72a9c';
    const KEY_DAYCOMP = `bp_progress_${NIVEL}`; // dia completo: 1, 0
    const HABITS = [
      {id:'forca',        label:'Treino de força / Musculação'},
      {id:'agua',         label:'Ingestão adequada de água'},
      {id:'sono',         label:'Higiene do sono'},
      {id:'movimento',    label:'Movimento do dia'},
      {id:'alimentacao',  label:'Alimentação consciente'},
      {id:'mobilidade',   label:'Mobilidade/Postura'},
      {id:'sol',          label:'Ar livre / Sol'}
    ];
    const $ = s => document.querySelector(s);
    const iso = d => new Date(d).toISOString().slice(0,10);
    const today = () => iso(new Date());
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return iso(x); }
    const LS = {
      get:(k,def)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch(_){return def} },
      set:(k,v)=> localStorage.setItem(k, JSON.stringify(v))
    };
    const keyHabit = hid => `bp_habit_hist_${NIVEL}_${hid}`;

    function renderHabitDots(){
      const wrap = $('#streakList');
      if(!wrap) return;
      wrap.innerHTML = '';
      const days = [];
      for(let i=19;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); days.push(iso(d)); }
      HABITS.forEach(h=>{
        const hist = LS.get(keyHabit(h.id), {});
        const row  = document.createElement('div');
        row.className = 'streak-row';
        const label = document.createElement('div');
        label.className = 'streak-label';
        label.textContent = h.label;
        const grid = document.createElement('div');
        grid.className = 'streak-grid';
        days.forEach(k=>{
          const el = document.createElement('i');
          el.className = 'dot' + (hist[k]===1?' ok':(hist[k]===0?' no':''));
          grid.appendChild(el);
        });
        row.appendChild(label);
        row.appendChild(grid);
        wrap.appendChild(row);
      });
    }

    function updateGoalProgress(){
      const hist = LS.get(KEY_DAYCOMP, {});
      const goalWrap = $('#goalCurrentWrap');
      if(!goalWrap) return;
      const goalName = $('#goalCurrentName');
      const goalProg = $('#goalProgress');
      const goalTxt  = $('#goalProgressText');
      const goalNote = $('#goalResetNote');

      const daysTarget = parseInt(($('#goal_days')?.value)||0,10) || 20;
      const name = ($('#goal_name')?.value)||'Recompensa';

      const dates = Object.keys(hist).sort();
      let lastResetIdx = -1;
      for(let i=0;i<dates.length;i++){
        const a = hist[dates[i]]   ?? null;
        const b = hist[dates[i+1]] ?? null;
        const c = hist[dates[i+2]] ?? null;
        if(a===0 && b===0 && c===0){ lastResetIdx = i+2; }
      }
      let startCountIdx = (lastResetIdx>=0) ? lastResetIdx+1 : 0;
      let completed = 0;
      for(let i=startCountIdx;i<dates.length;i++){
        if(hist[dates[i]]===1) completed++;
      }
      goalWrap.style.display = 'block';
      goalName.textContent = name;
      const pct = Math.max(0, Math.min(100, Math.round((completed / daysTarget) * 100)));
      goalProg.style.width = pct + '%';
      goalTxt.textContent = `Progresso: ${completed}/${daysTarget} dias completos`;
      goalNote.style.display = lastResetIdx>=0 ? 'block' : 'none';
    }

    /* =========================
       AJUSTE ÚNICO: hookSaveDay com SNAPSHOT
       ========================= */
    function hookSaveDay(){
      const saveBtn = document.getElementById('btnSaveDay');
      if(!saveBtn) return;

      saveBtn.addEventListener('click', ()=>{
        // Snapshot imediato do estado dos checkboxes, antes do script original limpar a UI
        const snap = {};
        HABITS.forEach(h=>{
          const el = document.querySelector(`input[type="checkbox"][data-habit="${h.id}"]`);
          snap[h.id] = !!(el && el.checked);
        });

        // Gravação no storage após o fluxo original concluir
        setTimeout(()=> {
          const todayISO = today();

          // histórico por hábito
          HABITS.forEach(h=>{
            const hist = LS.get(keyHabit(h.id), {});
            hist[todayISO] = snap[h.id] ? 1 : 0;
            LS.set(keyHabit(h.id), hist);
          });

          // dia completo (todos essenciais marcados no snapshot)
          const essentials = ['agua','sono','movimento','alimentacao'];
          const all = essentials.every(id => snap[id]);
          const dcomp = LS.get(KEY_DAYCOMP, {});
          dcomp[todayISO] = all ? 1 : 0;
          LS.set(KEY_DAYCOMP, dcomp);

          // regra: 3 ausências seguidas zeram contagem
          const d1 = todayISO, d0 = addDays(d1, -1), dm1 = addDays(d1, -2);
          if( (dcomp[dm1]===0) && (dcomp[d0]===0) && (dcomp[d1]===0) ){
            LS.set(`bp_progress_reset_at_${NIVEL}`, d1);
          }

          renderHabitDots();
          updateGoalProgress();
        }, 0);
      });
    }

    function hookClearDay(){
      const btn = document.getElementById('btnClearDay');
      if(!btn) return;
      btn.addEventListener('click', ()=> setTimeout(renderHabitDots, 60));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderHabitDots();
      updateGoalProgress();
      hookSaveDay();
      hookClearDay();
      // expõe para o script de metas reutilizar
      window.updateGoalProgress = updateGoalProgress;
    });
  })();
  </script>

  <!-- Script ORIGINAL de comportamento geral da página -->
  <script src="./habitos.js?v=18" defer></script>

  <!-- Script EXTRA (somente metas) – mantém excluir/definir alvo -->
  <script defer>
  (function(){
    const NIVEL = window.NIVEL || 'fundacao-72a9c';
    const GOALS_KEY = `bp_goals_${NIVEL}`;
    const CUR_KEY   = `bp_goal_current_${NIVEL}`;
    const $ = s=>document.querySelector(s);
    const LS = {get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(_){return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
    const esc = s => (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const goals = ()=>LS.get(GOALS_KEY,[]);
    const save  = g => LS.set(GOALS_KEY,g);

    function renderGoals(){
      const box=$('#goalsList'); if(!box) return;
      const arr=goals();
      const cur=LS.get(CUR_KEY,null)?.id||null;
      if(!arr.length){ box.innerHTML='<div class="muted">Nenhuma meta cadastrada ainda.</div>'; return; }
      box.innerHTML = arr.map(g=>`
        <div class="goal-card" data-id="${g.id}">
          <div class="hdr">
            <div class="name">${esc(g.name)}</div>
            <div class="small muted">${g.createdISO||''}</div>
          </div>
          <small class="muted">0/${g.days} dias completos</small>
          <div class="row-actions" style="margin-top:8px">
            <button class="btn ${cur===g.id?'':'ghost'}" data-set="${g.id}">${cur===g.id?'Alvo atual':'Definir como alvo'}</button>
            <button class="btn ghost" data-del="${g.id}">Excluir</button>
          </div>
        </div>`).join('');
    }

    function setCurrent(goal){
      LS.set(CUR_KEY, goal?{id:goal.id,name:goal.name,days:goal.days}:null);
      if($('#goal_name')) $('#goal_name').value = goal?.name || '';
      if($('#goal_days')) $('#goal_days').value = goal?.days || '';
      if(typeof window.updateGoalProgress==='function') window.updateGoalProgress();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      renderGoals();
      const btnSave = document.getElementById('btnSaveGoal');
      const btnClear= document.getElementById('btnClearGoal');
      const list    = document.getElementById('goalsList');

      btnSave?.addEventListener('click', (e)=>{
        e.stopImmediatePropagation(); e.preventDefault();
        const name = ($('#goal_name')?.value||'').trim();
        const days = parseInt($('#goal_days')?.value,10)||20;
        if(!name) return;
        const arr = goals();
        const goal = { id: Date.now().toString(36), name, days, createdISO: new Date().toISOString().slice(0,10) };
        arr.unshift(goal); save(arr); setCurrent(goal); renderGoals();
      }, true);

      btnClear?.addEventListener('click', (e)=>{
        e.stopImmediatePropagation(); e.preventDefault();
        if($('#goal_name')) $('#goal_name').value='';
        if($('#goal_days')) $('#goal_days').value='';
      }, true);

      list?.addEventListener('click', (e)=>{
        const t = e.target;
        const delId = t?.dataset?.del;
        const setId = t?.dataset?.set;
        if(delId){
          e.stopImmediatePropagation(); e.preventDefault();
          const arr = goals().filter(g=>g.id!==delId); save(arr);
          const cur = LS.get(CUR_KEY,null);
          if(cur && cur.id===delId) setCurrent(null);
          renderGoals();
          return;
        }
        if(setId){
          e.stopImmediatePropagation(); e.preventDefault();
          const g = goals().find(x=>x.id===setId); if(g){ setCurrent(g); renderGoals(); }
        }
      }, true);
    });
  })();
  </script>
</body>
</html>