<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>EVO360 ¬∑ Ascens√£o ¬∑ H√°bitos e Recompensas</title>
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" href="../../assets/css/base.css?v=18">
  <link rel="stylesheet" href="../../assets/css/tema-fundacao.css?v=18">
  <meta name="theme-color" content="#0b0d10">
  <style>
    /* ===== Ajustes locais desta p√°gina (inalterados) ===== */
    .content p, .content li { text-align: justify; }

    /* Tabs ‚Äî tudo numa linha, com rolagem lateral se precisar */
    .tabs{
      display:flex;
      gap:8px;
      margin:12px 0;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0f1318;
      cursor:pointer;
      white-space:nowrap;
    }
    .tab.active{border-color:rgba(203,229,255,.35);background:#12161B}

    .panel{display:none}
    .panel.active{display:block}

    /* Listas de h√°bitos */
    .habits-group{margin-top:12px}
    .habits-title{font-weight:800;margin:8px 0}
    .habits-grid{display:grid;grid-template-columns:1fr;gap:10px;align-items:center}
    @media (min-width:760px){ .habits-grid{grid-template-columns:1fr 1fr} }
    .habit-item{display:flex;align-items:center;gap:10px;border:1px solid var(--line);background:#0f1318;padding:10px;border-radius:12px;min-height:48px}
    .habit-item input[type="checkbox"]{width:20px;height:20px;cursor:pointer}

    .row-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Meta atual / progresso */
    .progress-wrap{margin-top:10px}
    .progress{height:8px;border-radius:999px;background:#0d1116;border:1px solid var(--line);overflow:hidden}
    .progress > i{display:block;height:100%}
    .muted-ok{display:flex;gap:8px;align-items:center;margin-top:10px}

    /* Lista de metas salvas */
    .goal-list{display:grid;gap:10px;margin-top:10px}
    .goal-card{border:1px solid var(--line);background:#0f1318;border-radius:12px;padding:10px}
    .goal-card .hdr{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .goal-card .name{font-weight:700}
    .goal-card small{color:var(--silver)}
    .goal-card[data-edit]{cursor:pointer}

    /* === Progresso (20 dias por h√°bito) === */
    .streak-box{ margin-top:18px }
    .streak-legend{ color:var(--silver); margin-top:6px }
    .streak-list{ display:grid; gap:12px; margin-top:12px }
    .streak-row{ display:flex; flex-direction:column; gap:6px }
    .streak-label{ color:var(--silver); font-weight:600 }
    .streak-grid{ display:grid; grid-template-columns:repeat(20,12px); gap:6px; }
    .dot{ width:12px; height:12px; border-radius:50%; background:#40464f; border:1px solid #30343b }
    .dot.ok{ background:#31b57a; border-color:#2a9465 }
    .dot.no{ background:#d04c4c; border-color:#a53b3b }

    /* üîí Esconde o contador do formul√°rio de meta (mantemos s√≥ nos cards) */
    #goalCurrentWrap { display: none !important; }

    /* ===== Overrides de COR para o tema Ascens√£o (apenas cor, sem layout) ===== */
    :root{ --emerald:#00b37e; }
    .content h2, .card h2, .content .card h2 { color: var(--emerald) !important; }
    .habits-title { color: var(--emerald) !important; }
    .tab.active { border-color: rgba(0,179,126,.35) !important; background:#10211b !important; color: var(--emerald) !important; }
    .btn:not(.ghost){ background: var(--emerald) !important; border-color: transparent !important; color:#fff !important; }
    .btn.ghost{ background:transparent !important; border:1px solid var(--emerald) !important; color:var(--emerald) !important; }
    .btn.ghost:hover{ background:var(--emerald) !important; color:#fff !important; }
    .habit-item input[type="checkbox"]{ accent-color: var(--emerald); }
    .progress > i{ background: linear-gradient(90deg, #00b37e, #00d08f); }
  </style>
</head>

<body class="layout-with-sidebar">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Navega√ß√£o do N√≠vel Ascens√£o">
    <div class="sb-header">
      <img src="../../assets/img/logo.svg" class="logo" alt="EVO360">
      <div class="nivel">N√≠vel Ascens√£o</div>
    </div>
    <nav class="sb-nav">
      <a class="sb-item" href="./">In√≠cio</a>
      <a class="sb-item" href="./dicas-orientacoes.html">Dicas e Orienta√ß√µes</a>
      <a class="sb-item" href="./plano.html">Tarefas e Neuro-H√°bito</a>
      <a class="sb-item active" href="./habitos.html">H√°bitos e Recompensas</a>
      <a class="sb-item" href="./praticas.html">Pr√°ticas Mentais</a>
      <a class="sb-item" href="./suporte.html">Suporte</a>
    </nav>
    <div class="sb-footer"><div class="quote">Voc√™ est√° florescendo.</div><div class="ver">v1.0 ¬∑ ¬© Bella Prime</div></div>
  </aside>

  <!-- Conte√∫do -->
  <main class="content">
    <!-- Banner (Ascens√£o) -->
    <header class="banner-full" style="background:url('../../assets/img/hub/banner-ascensao-hero.jpg?v=22') center/cover no-repeat !important; background-image:url('../../assets/img/hub/banner-ascensao-hero.jpg?v=22') !important;" aria-hidden="true"></header>

    <!-- Card -->
    <section class="card">
      <h2>H√°bitos e Recompensas</h2>
      <p>
        Marque seus h√°bitos <strong>diariamente</strong>, defina uma <strong>recompensa significativa</strong> e acompanhe sua evolu√ß√£o.
        O objetivo √© cultivar const√¢ncia, celebrar conquistas e manter um ritmo sustent√°vel ao longo do N√≠vel Ascens√£o (60 dias).
      </p>

      <div class="tabs">
        <button class="tab active" data-tab="rastreador">H√°bitos</button>
        <button class="tab" data-tab="recompensas">Recompensas</button>
        <button class="tab" data-tab="ferramentas">Ferramentas</button>
      </div>

      <!-- Painel: H√°bitos -->
      <div class="panel active" id="panel-rastreador">
        <p class="muted">Marque os h√°bitos do dia. Ao salvar, as marca√ß√µes de hoje ficam bloqueadas at√© amanh√£.</p>

        <div class="habits-group">
          <div class="habits-title">Essenciais (contam para ‚Äúdia completo‚Äù)</div>
          <div class="habits-grid" id="essenciais">
            <label class="habit-item"><input type="checkbox" data-habit="agua"><span>√Ågua na meta do dia</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="sono"><span>Higiene do sono (rotina + ‚â•7h)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="movimento"><span>Movimento do dia (‚â•30 min leve/mod.)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="alimentacao"><span>Alimenta√ß√£o consciente (3 boas escolhas)</span></label>
          </div>
        </div>

        <div class="habits-group">
          <div class="habits-title">Complementares (registro extra)</div>
          <div class="habits-grid" id="complementares">
            <label class="habit-item"><input type="checkbox" data-habit="mobilidade"><span>Mobilidade/Postura (5‚Äì10 min)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="sol"><span>Ar livre / Sol (10‚Äì15 min)</span></label>
            <label class="habit-item"><input type="checkbox" data-habit="forca"><span>Treino de for√ßa/muscula√ß√£o</span></label>
          </div>
        </div>

        <div class="row-actions">
          <button class="btn" id="btnSaveDay">Salvar dia</button>
          <button class="btn ghost" id="btnClearDay">Limpar marca√ß√µes</button>
        </div>

        <div class="alert info muted-ok" id="saveInfo" style="display:none">
          <span>‚úÖ Dia salvo. As marca√ß√µes de hoje est√£o bloqueadas. Volte amanh√£.</span>
        </div>

        <!-- Progresso 20 dias por h√°bito -->
        <div class="streak-box" id="progress20">
          <h3 class="habits-title">Progresso (√∫ltimos 20 dias)</h3>
          <div class="streak-legend">Verde = marcado; Vermelho = n√£o marcado; Cinza = sem registro.</div>
          <div id="streakList" class="streak-list" aria-live="polite"></div>
        </div>
      </div>

      <!-- Painel: Recompensas -->
      <div class="panel" id="panel-recompensas">
        <h3 class="habits-title">Meta de recompensa (baseada em dias completos)</h3>

        <div class="grid-2">
          <label>Recompensa (ex.: ‚ÄúSpa em casa‚Äù, ‚ÄúFilme + pipoca‚Äù)<br>
            <input type="text" id="goal_name" placeholder="Ex.: Spa em casa">
          </label>
          <label>Dias completos para merecer<br>
            <input type="number" id="goal_days" min="1" max="60" placeholder="Ex.: 20">
          </label>
        </div>

        <div class="row-actions">
          <button class="btn" id="btnSaveGoal">Salvar meta</button>
          <button class="btn ghost" id="btnClearGoal">Limpar meta</button>
        </div>

        <!-- (contador escondido por CSS) -->
        <div class="progress-wrap" id="goalCurrentWrap" style="display:none">
          <div class="muted">Alvo: <strong id="goalCurrentName"></strong></div>
          <div class="progress"><i id="goalProgress" style="width:0%"></i></div>
          <div class="muted" id="goalProgressText">Progresso: ‚Äî</div>
          <div class="muted" id="goalResetNote" style="display:none">Contagem reiniciada por 3 aus√™ncias seguidas.</div>
        </div>

        <hr class="divisor">

        <h3 class="habits-title">Minhas metas</h3>
        <div id="goalsList" class="goal-list">
          <div class="muted">Nenhuma meta cadastrada ainda.</div>
        </div>

        <p class="muted" style="margin-top:12px">
          <strong>Regra:</strong> caso ocorram <strong>3 aus√™ncias seguidas</strong> (dias n√£o completos),
          a contagem da recompensa √© <strong>zerada</strong> automaticamente.
        </p>
      </div>

      <!-- Painel: Ferramentas (simples) -->
      <div class="panel" id="panel-ferramentas">
        <p class="muted">Pequenas ferramentas que ajudam a manter bons h√°bitos.</p>
        <div class="grid-2">
          <label>Calculadora simples de √°gua (ml/kg) ‚Äî alvo sugerido 30‚Äì35 ml/kg<br>
            <input type="number" id="w_peso" placeholder="Peso (kg)">
          </label>
          <div class="calc-out" id="w_out">Informe seu peso para estimar a meta di√°ria de √°gua.</div>
        </div>
      </div>
    </section>
  </main>

  <script>window.NIVEL="ascensao-9f3b2";</script>

  <!-- ===== Scripts originais (intactos) ===== -->
  <script>
  // ===== Helpers =====
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const LS = {
    get:(k,def=null)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def }catch(_){ return def } },
    set:(k,v)=>localStorage.setItem(k, JSON.stringify(v)),
    del:(k)=>localStorage.removeItem(k)
  };
  const iso = d => new Date(d).toISOString().slice(0,10);
  const todayISO = () => iso(new Date());

  // Keys por n√≠vel
  const LEVEL = window.NIVEL || "fundacao-72a9c";
  const K = {
    dayLog:   (date) => `hab_${LEVEL}_day_${date}`,
    daySaved: (date) => `hab_${LEVEL}_saved_${date}`,
    daysDone:         `hab_${LEVEL}_days_complete`,
    goalCurrent:      `hab_${LEVEL}_goal_current`,
    goalArchive:      `hab_${LEVEL}_goal_archive`
  };

  // ===== Tabs =====
  (function tabs(){
    const map = { rastreador: '#panel-rastreador', recompensas:'#panel-recompensas', ferramentas:'#panel-ferramentas' };
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $$('.panel').forEach(p=>p.classList.remove('active'));
        $(map[btn.dataset.tab]).classList.add('active');
      });
    });
  })();

  // ===== Rastreador: carregar estado do dia =====
  const today = todayISO();
  const savedToday = !!LS.get(K.daySaved(today), false);

  function setDisabledAll(disabled){
    $$('#panel-rastreador input[type="checkbox"]').forEach(cb => cb.disabled = disabled);
    $('#btnSaveDay').disabled = disabled;
    $('#btnClearDay').disabled = disabled;
  }
  function loadDay(){
    const log = LS.get(K.dayLog(today), {});
    $$('#panel-rastreador input[type="checkbox"]').forEach(cb=>{
      const id = cb.dataset.habit;
      cb.checked = !!log[id];
    });
    if(savedToday){
      setDisabledAll(true);
      $('#saveInfo').style.display = 'flex';
    }else{
      setDisabledAll(false);
      $('#saveInfo').style.display = 'none';
    }
  }
  loadDay();

  // Limpar marca√ß√µes (sem salvar)
  $('#btnClearDay').addEventListener('click', ()=>{
    if(savedToday) return;
    $$('#panel-rastreador input[type="checkbox"]').forEach(cb=> cb.checked = false);
    LS.set(K.dayLog(today), {});
  });

  // Auto-rascunho ao clicar
  $$('#panel-rastreador input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      if(savedToday) return;
      const log = LS.get(K.dayLog(today), {});
      log[cb.dataset.habit] = cb.checked;
      LS.set(K.dayLog(today), log);
    });
  });

  // Salvar dia
  $('#btnSaveDay').addEventListener('click', ()=>{
    if(savedToday) return;

    const log = LS.get(K.dayLog(today), {});
    const essentials = ['agua','sono','movimento','alimentacao'];
    const allEssential = essentials.every(h => !!log[h]);

    LS.set(K.daySaved(today), true);

    if(allEssential){
      const done = +LS.get(K.daysDone, 0) + 1;
      LS.set(K.daysDone, done);
      const cur = LS.get(K.goalCurrent, null);
      if(cur){
        cur.progressDays = Math.min(cur.target, (cur.progressDays||0) + 1);
        LS.set(K.goalCurrent, cur);
      }
    }

    setDisabledAll(true);
    $('#saveInfo').style.display = 'flex';
    renderGoal();
  });

  // ===== Recompensas =====
  function esc(s){ return (s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  function renderGoalsArchive(){
    const list = $('#goalsList');
    list.innerHTML = '';

    const cur = LS.get(K.goalCurrent, null);
    const arc = LS.get(K.goalArchive, []);

    if(!cur && !arc.length){
      list.innerHTML = '<div class="muted">Nenhuma meta cadastrada ainda.</div>';
      return;
    }

    if(cur){
      const pctCur = Math.round(Math.min(100, ((cur.progressDays||0)/(cur.target||1))*100));
      const nodeCur = document.createElement('div');
      nodeCur.className = 'goal-card';
      nodeCur.innerHTML = `
        <div class="hdr">
          <div class="name">${esc(cur.name || 'Meta ativa')}</div>
          <small>${cur.startedISO || '‚Äî'}</small>
        </div>
        <div class="progress" style="margin-top:6px"><i style="width:${pctCur}%"></i></div>
        <small>${cur.progressDays||0}/${cur.target} dias completos ¬∑ <span class="muted">Meta ativa</span></small>
      `;
      list.appendChild(nodeCur);
    }

    arc.forEach((g,i)=>{
      const pct = Math.round(Math.min(100, ((g.progressDays||0)/(g.target||1))*100));
      const node = document.createElement('div');
      node.className = 'goal-card';
      node.innerHTML = `
        <div class="hdr">
          <div class="name">${esc(g.name || 'Meta')}</div>
          <small>${g.startedISO || '‚Äî'}</small>
        </div>
        <div class="progress" style="margin-top:6px"><i style="width:${pct}%"></i></div>
        <small>${g.progressDays||0}/${g.target} dias completos</small>
        <div class="row-actions" style="margin-top:8px">
          <button class="btn ghost" data-del="${i}">Excluir</button>
        </div>
      `;
      list.appendChild(node);
    });
  }

  function renderGoal(){
    const cur = LS.get(K.goalCurrent, null);
    const wrap = $('#goalCurrentWrap');
    if(!cur){
      wrap.style.display='none';
      renderGoalsArchive();
      return;
    }
    wrap.style.display = '';
    $('#goalCurrentName').textContent = cur.name || 'Meta';
    const pct = Math.round(Math.min(100, (cur.progressDays/cur.target)*100));
    $('#goalProgress').style.width = pct + '%';
    $('#goalProgressText').textContent = `Progresso: ${cur.progressDays}/${cur.target} dias completos`;
    renderGoalsArchive();
  }
  renderGoal();

  $('#btnSaveGoal').addEventListener('click', ()=>{
    const name = $('#goal_name').value.trim();
    const target = Math.max(1, Math.min(60, +($('#goal_days')?.value || 0)));
    if(!name || !target){ return; }

    const prev = LS.get(K.goalCurrent, null);
    if(prev){
      const arc = LS.get(K.goalArchive, []);
      arc.unshift(prev);
      LS.set(K.goalArchive, arc);
    }

    const cur = { name, target, startedISO: todayISO(), progressDays: 0 };
    LS.set(K.goalCurrent, cur);

    $('#goal_name').value = '';
    $('#goal_days').value = '';
    renderGoal();
  });

  $('#btnClearGoal').addEventListener('click', ()=>{
    const cur = LS.get(K.goalCurrent, null);
    if(cur){
      const arc = LS.get(K.goalArchive, []);
      arc.unshift(cur);
      LS.set(K.goalArchive, arc);
      LS.del(K.goalCurrent);
      renderGoal();
    }
  });

  document.getElementById('goalsList')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-del]');
    if(!btn) return;
    const idx = +btn.dataset.del;
    const arc = LS.get(K.goalArchive, []);
    if (Number.isInteger(idx) && idx >= 0 && idx < arc.length) {
      arc.splice(idx, 1);
      LS.set(K.goalArchive, arc);
      renderGoalsArchive();
    }
  });

  // ===== Ferramentas: √°gua =====
  (function waterTool(){
    const peso = $('#w_peso'), out = $('#w_out');
    function calc(){
      const p = +peso.value || 0;
      if(p>0){
        const low = Math.round(p*30), high = Math.round(p*35);
        out.innerHTML = `Meta sugerida: <strong>${low}‚Äì${high} ml/dia</strong> (30‚Äì35 ml/kg).`;
      }else{
        out.textContent = 'Informe seu peso para estimar a meta di√°ria de √°gua.';
      }
    }
    peso.addEventListener('input', calc);
    calc();
  })();
  </script>

  <!-- For√ßa r√≥tulos das abas (compatibilidade) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabHab = document.querySelector('.tabs .tab[data-tab="rastreador"]');
    const tabRec = document.querySelector('.tabs .tab[data-tab="recompensas"]');
    const tabFer = document.querySelector('.tabs .tab[data-tab="ferramentas"]');
    if (tabHab) tabHab.textContent = 'H√°bitos';
    if (tabRec) tabRec.textContent = 'Recompensas';
    if (tabFer) tabFer.textContent = 'Ferramentas';
  });
  </script>

  <!-- Script adicional (progresso, datas locais, etc.) ‚Äî intacto -->
  <script>
  (function(){
    const NIVEL = window.NIVEL || 'fundacao-72a9c';
    const KEY_DAYCOMP = `bp_progress_${NIVEL}`;
    const HABITS = [
      {id:'forca',label:'Treino de for√ßa / Muscula√ß√£o'},
      {id:'agua',label:'Ingest√£o adequada de √°gua'},
      {id:'sono',label:'Higiene do sono'},
      {id:'movimento',label:'Movimento do dia'},
      {id:'alimentacao',label:'Alimenta√ß√£o consciente'},
      {id:'mobilidade',label:'Mobilidade/Postura'},
      {id:'sol',label:'Ar livre / Sol'}
    ];
    const $ = s=>document.querySelector(s);
    const toDate = v => (v instanceof Date)?new Date(v):new Date(String(v).replace(/T.*$/,'T00:00:00'));
    const localISO = (v=new Date())=>{const d=toDate(v);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
    const today = ()=>localISO(new Date());
    const addDays = (iso,n)=>{const d=toDate(`${iso}T00:00:00`);d.setDate(d.getDate()+n);return localISO(d);}
    const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(_){return d}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
    const keyHabit = hid => `bp_habit_hist_${NIVEL}_${hid}`;

    const MIGR_KEY=`bp_localdate_migrated_${NIVEL}`;
    function migrateToLocalKeys(){
      if(LS.get(MIGR_KEY,false)) return;
      const isLocal=k=>/^\d{4}-\d{2}-\d{2}$/.test(k);
      HABITS.forEach(h=>{
        const hist=LS.get(keyHabit(h.id),null); if(!hist) return;
        let changed=false; const newer={};
        for(const [k,v] of Object.entries(hist)){
          if(isLocal(k)){ newer[k]=v; continue; }
          const loc=localISO(new Date(k)); newer[loc]=v; changed=changed||loc!==k;
        }
        if(changed) LS.set(keyHabit(h.id),newer);
      });
      const dcomp=LS.get(KEY_DAYCOMP,null);
      if(dcomp){
        let changed=false; const newer={};
        for(const [k,v] of Object.entries(dcomp)){
          if(/^\d{4}-\d{2}-\d{2}$/.test(k)){ newer[k]=v; continue; }
          const loc=localISO(new Date(k)); newer[loc]=v; changed=changed||loc!==k;
        }
        if(changed) LS.set(KEY_DAYCOMP,newer);
      }
      LS.set(MIGR_KEY,true);
    }

    function renderHabitDots(){
      const wrap=$('#streakList'); if(!wrap) return; wrap.innerHTML='';
      const days=[]; for(let i=19;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); days.push(localISO(d)); }
      HABITS.forEach(h=>{
        const hist=LS.get(keyHabit(h.id),{});
        const row=document.createElement('div'); row.className='streak-row';
        const label=document.createElement('div'); label.className='streak-label'; label.textContent=h.label;
        const grid=document.createElement('div'); grid.className='streak-grid';
        days.forEach(k=>{ const el=document.createElement('i'); el.className='dot'+(hist[k]===1?' ok':(hist[k]===0?' no':'')); grid.appendChild(el); });
        row.appendChild(label); row.appendChild(grid); wrap.appendChild(row);
      });
    }

    function updateGoalProgress(){
      const hist=LS.get(KEY_DAYCOMP,{}), wrap=$('#goalCurrentWrap'); if(!wrap) return;
      const name=($('#goal_name')?.value)||'Recompensa';
      const target=parseInt(($('#goal_days')?.value)||0,10)||20;
      const dates=Object.keys(hist).sort();
      let lastReset=-1; for(let i=0;i<dates.length;i++){
        const a=hist[dates[i]],b=hist[dates[i+1]],c=hist[dates[i+2]];
        if(a===0&&b===0&&c===0){ lastReset=i+2; }
      }
      let start=(lastReset>=0)?lastReset+1:0, done=0;
      for(let i=start;i<dates.length;i++){ if(hist[dates[i]]===1) done++; }
      wrap.style.display='block';
      $('#goalCurrentName').textContent=name;
      $('#goalProgress').style.width=Math.max(0,Math.min(100,Math.round((done/target)*100)))+'%';
      $('#goalProgressText').textContent=`Progresso: ${done}/${target} dias completos`;
      $('#goalResetNote').style.display=lastReset>=0?'block':'none';
    }

    function hookSaveDay(){
      const btn=document.getElementById('btnSaveDay'); if(!btn) return;
      btn.addEventListener('click',()=>{
        const snap={}; HABITS.forEach(h=>{ const el=document.querySelector(`input[type="checkbox"][data-habit="${h.id}"]`); snap[h.id]=!!(el&&el.checked); });
        setTimeout(()=>{
          const t=today();
          HABITS.forEach(h=>{ const hist=LS.get(keyHabit(h.id),{}); hist[t]=snap[h.id]?1:0; LS.set(keyHabit(h.id),hist); });
          const essentials=['agua','sono','movimento','alimentacao'];
          const all=essentials.every(id=>snap[id]); const dcomp=LS.get(KEY_DAYCOMP,{}); dcomp[t]=all?1:0; LS.set(KEY_DAYCOMP,dcomp);
          const d1=t,d0=addDays(d1,-1),dm1=addDays(d1,-2);
          if(dcomp[dm1]===0&&dcomp[d0]===0&&dcomp[d1]===0){ LS.set(`bp_progress_reset_at_${NIVEL}`,d1); }
          renderHabitDots(); updateGoalProgress();
        },0);
      });
    }
    function hookClearDay(){ const b=document.getElementById('btnClearDay'); if(!b) return; b.addEventListener('click',()=>setTimeout(renderHabitDots,60)); }

    document.addEventListener('DOMContentLoaded',()=>{
      migrateToLocalKeys();
      renderHabitDots();
      updateGoalProgress();
      hookSaveDay();
      hookClearDay();
      window.updateGoalProgress=updateGoalProgress;
    });
  })();
  </script>
</body>
</html>
